<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ponuda</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px 0; }
    .muted { color:#666; font-size:13px; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0; }
    .btn { border:1px solid #ccc; background:#f7f7f7; padding:8px 12px; cursor:pointer; }
    .btn-primary { border:1px solid #333; background:#eaeaea; font-weight:bold; }
    label { display:block; font-size:13px; margin: 10px 0 6px; color:#444; }
    input, select { width:100%; padding:10px; border:1px solid #ccc; box-sizing:border-box; }
    table { width:100%; border-collapse:collapse; margin-top:14px; }
    th, td { border:1px solid #ddd; padding:10px; }
    th { background:#f2f2f2; text-align:left; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: 1 / -1; }
    .right { text-align:right; }
    .warn { background:#fff6d6; border:1px solid #e6c65c; padding:10px 12px; margin:10px 0; }
    .topline { display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="topline">
    <div>
      <h1>Ponuda</h1>
      <div class="muted">Prijavljen: {{ user }}</div>
      <div class="muted">Ponuda #{{ offer.id }} • {{ (offer.created_at|string)[:16] }}</div>
    </div>
    <form method="post" action="/logout">
      <button class="btn" type="submit">Odjava</button>
    </form>
  </div>

  {% if locked %}
    <div class="warn">Ova ponuda je zaključana (status: <b>ACCEPTED</b>). Stavke se ne mogu mijenjati.</div>
  {% endif %}

  <div class="actions">
    <form method="post" action="/offer/new" style="margin:0;">
      <button class="btn" type="submit">Nova ponuda</button>
    </form>
    <a href="/offers"><button class="btn" type="button">Sve ponude</button></a>
    <a href="/settings"><button class="btn" type="button">Postavke firme</button></a>
    <a href="/download/excel"><button class="btn" type="button">Download Excel</button></a>
    <a href="/download/pdf"><button class="btn" type="button">Download PDF</button></a>
    <form method="post" action="/items/clear" style="margin:0;">
      <button class="btn" type="submit" {% if locked %}disabled{% endif %}>Obriši sve stavke</button>
    </form>
    <div><b>Međuzbroj:</b> {{ subtotal }} € • <b>PDV {{ vat_rate }}%:</b> {{ vat }} € • <b>Ukupno:</b> {{ total }} €</div>
  </div>

  <div class="grid">
    <div class="full">
      <form method="post" action="/offer/client">
        <label>Naziv klijenta</label>
        <div style="display:flex; gap:10px; align-items:center;">
          <input name="client_name" value="{{ offer.client_name or '' }}" placeholder="npr. Ivan Horvat" {% if locked %}disabled{% endif %}>
          <button class="btn btn-primary" type="submit" {% if locked %}disabled{% endif %}>Spremi</button>
        </div>
      </form>
      <div class="muted">Ovo ide u PDF i Excel.</div>
    </div>

    <div>
      <form method="post" action="/offer/status">
        <label>Status</label>
        <div style="display:flex; gap:10px; align-items:center;">
          <select name="status">
            {% set st = (offer.status or 'DRAFT')|upper %}
            <option value="DRAFT" {% if st=='DRAFT' %}selected{% endif %}>DRAFT</option>
            <option value="SENT" {% if st=='SENT' %}selected{% endif %}>SENT</option>
            <option value="ACCEPTED" {% if st=='ACCEPTED' %}selected{% endif %}>ACCEPTED</option>
          </select>
          <button class="btn btn-primary" type="submit">Spremi</button>
        </div>
        <div class="muted">Samo <b>ACCEPTED</b> zaključava ponudu.</div>
      </form>
    </div>

    <div class="full">
      <h3>Detalji za PDF</h3>
      <form id="metaForm">
        <div class="grid">
          <div>
            <label>Mjesto</label>
            <input name="place" value="{{ offer.place or '' }}" placeholder="npr. Velika Gorica" {% if locked %}disabled{% endif %}>
          </div>
          <div>
            <label>Potpis (ime i prezime)</label>
            <input name="signature" value="{{ offer.signature or '' }}" placeholder="npr. Marko Makaj" {% if locked %}disabled{% endif %}>
          </div>
          <div>
            <label>Rok isporuke</label>
            <input name="delivery" value="{{ offer.delivery or '' }}" placeholder="npr. 21 dan" {% if locked %}disabled{% endif %}>
          </div>
          <div>
            <label>PDV</label>
            <select name="vat_rate" {% if locked %}disabled{% endif %}>
              {% for v in [0,5,13,25] %}
                <option value="{{ v }}" {% if (offer.vat_rate|int)==v %}selected{% endif %}>{{ v }}%</option>
              {% endfor %}
            </select>
          </div>
          <div class="full">
            <label>Rok plaćanja</label>
            <input name="payment" value="{{ offer.payment or '' }}" placeholder="npr. 50% avans, ostatak po isporuci" {% if locked %}disabled{% endif %}>
          </div>
          <div class="full">
            <label>Napomena</label>
            <input name="note" value="{{ offer.note or '' }}" placeholder="npr. Ponuda vrijedi 7 dana." {% if locked %}disabled{% endif %}>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button class="btn btn-primary" type="button" onclick="saveMeta()" {% if locked %}disabled{% endif %}>Spremi detalje za PDF</button>
        </div>
      </form>
    </div>
  </div>

  <h3>Stavke</h3>
  <form method="post" action="/item/add">
    <div class="grid">
      <div class="full">
        <label>Naziv</label>
        <input name="name" placeholder="npr. Ormar po mjeri" {% if locked %}disabled{% endif %} required>
      </div>
      <div>
        <label>Količina</label>
        <input name="qty" value="1" {% if locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Cijena</label>
        <input name="price" value="0" {% if locked %}disabled{% endif %}>
      </div>
    </div>
    <div style="margin-top:10px;">
      <button class="btn btn-primary" type="submit" {% if locked %}disabled{% endif %}>Dodaj</button>
    </div>
  </form>

  <table>
    <thead>
      <tr>
        <th>Naziv</th>
        <th class="right">Količina</th>
        <th class="right">Cijena</th>
        <th class="right">Ukupno</th>
        <th>Obriši</th>
      </tr>
    </thead>
    <tbody>
      {% if items|length == 0 %}
        <tr><td colspan="5" class="muted">Nema stavki još. Dodaj prvu stavku gore.</td></tr>
      {% endif %}
      {% for it in items %}
        <tr>
          <td>{{ it.name }}</td>
          <td class="right">{{ "%.2f"|format(it.qty) }}</td>
          <td class="right">{{ "%.2f"|format(it.price) }}</td>
          <td class="right">{{ "%.2f"|format(it.qty*it.price) }}</td>
          <td>
            <form method="post" action="/item/delete" style="margin:0;">
              <input type="hidden" name="item_id" value="{{ it.id }}">
              <button class="btn" type="submit" {% if locked %}disabled{% endif %}>X</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

<script>
async function saveMeta(){
  const form = document.getElementById('metaForm');
  const fd = new FormData(form);
  try{
    const res = await fetch('/offer/meta', {method:'POST', body: fd});
    if(!res.ok){
      alert('Greška kod spremanja detalja.');
      return;
    }
    const j = await res.json();
    if(!j || !j.ok){
      alert('Greška kod spremanja detalja.');
      return;
    }
    alert('Spremljeno.');
    location.reload();
  }catch(e){
    alert('Greška kod spremanja detalja.');
  }
}
</script>

</body>
</html>
