<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ponuda</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px 22px; }
    h1 { margin: 0 0 8px; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
    .muted { color:#666; font-size:13px; }
    .badge { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; margin:6px 0 10px; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0; }
    .btn { border:1px solid #ccc; background:#f7f7f7; padding:8px 12px; cursor:pointer; }
    .btn-primary { border:1px solid #333; background:#eaeaea; font-weight:bold; }
    .btn-danger { border:1px solid #d00; color:#b00; background:#fff5f5; }
    label { font-size:12px; color:#444; display:block; margin: 12px 0 4px; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; border:1px solid #ccc; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background:#f5f5f5; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: 1 / -1; }
    .right { text-align:right; }
    .lock { background:#fff7d6; border:1px solid #e6c972; padding:10px 12px; margin:10px 0; }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>Ponuda</h1>
      <div class="muted">Prijavljen: {{ user }}</div>
      <div class="badge">
        {{ offer.get('offer_no') or ('#' ~ offer.get('id')) }}
        • {{ (offer.get('created_at').strftime('%d.%m.%Y %H:%M') if offer and offer.get('created_at') else '') }}
      </div>
    </div>
    <form method="post" action="/logout">
      <button class="btn" type="submit">Odjava</button>
    </form>
  </div>

  {% if (offer.get('status') or 'DRAFT')|upper == 'ACCEPTED' %}
    <div class="lock"><b>Ova ponuda je zaključana (status: ACCEPTED).</b> Stavke i klijent se ne mogu mijenjati.</div>
  {% endif %}

  <div class="actions">
    <form method="post" action="/offer/new" style="margin:0;">
      <button class="btn" type="submit">Nova ponuda</button>
    </form>
    <a href="/offers"><button class="btn" type="button">Sve ponude</button></a>
    <a href="/settings"><button class="btn" type="button">Postavke firme</button></a>

    <form method="post" action="/offer/accept" style="margin:0;">
      <button class="btn btn-primary" type="submit">Prihvati ponudu</button>
    </form>

    <form method="post" action="/offer/items/clear" style="margin:0;">
      <button class="btn btn-danger" type="submit">Obriši sve stavke</button>
    </form>

    <div style="flex:1"></div>
    <div class="right">
      <b>Međuzbroj:</b> {{ '%.2f'|format(totals.subtotal) }} €
      • <b>PDV {{ totals.vat_rate }}%:</b> {{ '%.2f'|format(totals.vat) }} €
      • <b>Ukupno:</b> {{ '%.2f'|format(totals.total) }} €
    </div>
  </div>

  <div class="grid">
    <div>
      <form method="post" action="/offer/client" style="margin:0;">
        <label>Naziv klijenta</label>
        <div style="display:flex; gap:10px;">
          <input name="client_name" placeholder="npr. Ivan Horvat" value="{{ offer.get('client_name') or '' }}" />
          <button class="btn btn-primary" type="submit">Spremi</button>
        </div>
        <div class="muted" style="margin-top:6px;">Ovo ide u PDF i Excel.</div>
      </form>
    </div>

    <div>
      <form method="post" action="/offer/status" style="margin:0;">
        <label>Status</label>
        <div style="display:flex; gap:10px;">
          <select name="status">
            {% set st = (offer.get('status') or 'DRAFT')|upper %}
            <option value="DRAFT" {% if st=='DRAFT' %}selected{% endif %}>DRAFT</option>
            <option value="SENT" {% if st=='SENT' %}selected{% endif %}>SENT</option>
            <option value="ACCEPTED" {% if st=='ACCEPTED' %}selected{% endif %}>ACCEPTED</option>
          </select>
          <button class="btn btn-primary" type="submit">Spremi</button>
        </div>
        <div class="muted" style="margin-top:6px;">ACCEPTED zaključava ponudu.</div>
      </form>
    </div>

    <div>
      <label>Mjesto</label>
      <input id="place" value="{{ offer.get('place') or '' }}" placeholder="npr. Velika Gorica" />
    </div>

    <div>
      <label>Potpis (ime i prezime)</label>
      <input id="signed_by" value="{{ offer.get('signed_by') or '' }}" placeholder="npr. Marko Makaj" />
    </div>

    <div>
      <label>Rok isporuke</label>
      <input id="delivery_term" value="{{ offer.get('delivery_term') or '' }}" placeholder="npr. 21 dan" />
    </div>

    <div>
      <label>PDV</label>
      <select id="vat_rate">
        {% set vr = (offer.get('vat_rate') or 0)|int %}
        <option value="0" {% if vr==0 %}selected{% endif %}>0%</option>
        <option value="5" {% if vr==5 %}selected{% endif %}>5%</option>
        <option value="13" {% if vr==13 %}selected{% endif %}>13%</option>
        <option value="25" {% if vr==25 %}selected{% endif %}>25%</option>
      </select>
    </div>

    <div>
      <label>Rok plaćanja</label>
      <input id="payment_term" value="{{ offer.get('payment_term') or '' }}" placeholder="npr. 50% avans, ostatak po isporuci" />
    </div>

    <div class="full">
      <label>Napomena</label>
      <input id="note" value="{{ offer.get('note') or '' }}" placeholder="npr. Ponuda vrijedi 7 dana." />
    </div>

    <div class="full" style="display:flex; justify-content:flex-end;">
      <button class="btn btn-primary" type="button" onclick="saveMeta()">Spremi detalje za PDF</button>
    </div>
  </div>

  <hr style="margin:16px 0;" />

  <form method="post" action="/offer/item/add">
    <div class="grid">
      <div class="full">
        <label>Naziv</label>
        <input name="name" placeholder="npr. Ormar po mjeri" />
      </div>
      <div>
        <label>Količina</label>
        <input name="qty" value="1" />
      </div>
      <div>
        <label>Cijena</label>
        <input name="price" value="0" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-primary" type="submit">Dodaj</button>
      </div>
    </div>
  </form>

  <table>
    <thead>
      <tr>
        <th>Naziv</th>
        <th class="right">Količina</th>
        <th class="right">Cijena</th>
        <th class="right">Ukupno</th>
        <th>Obriši</th>
      </tr>
    </thead>
    <tbody>
      {% if items and items|length > 0 %}
        {% for it in items %}
        {% set line_total = (it.qty * it.price) %}
        <tr>
          <td>{{ it.name }}</td>
          <td class="right">{{ '%.2f'|format(it.qty) }}</td>
          <td class="right">{{ '%.2f'|format(it.price) }}</td>
          <td class="right">{{ '%.2f'|format(line_total) }}</td>
          <td>
            <form method="post" action="/offer/item/delete" style="margin:0;">
              <input type="hidden" name="item_id" value="{{ it.id }}" />
              <button class="btn btn-danger" type="submit">×</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="muted">Nema stavki još. Dodaj prvu stavku gore.</td></tr>
      {% endif %}
    </tbody>
  </table>

<script>
async function saveMeta() {
  const payload = new URLSearchParams();
  payload.set("place", document.getElementById("place").value || "");
  payload.set("signed_by", document.getElementById("signed_by").value || "");
  payload.set("delivery_term", document.getElementById("delivery_term").value || "");
  payload.set("payment_term", document.getElementById("payment_term").value || "");
  payload.set("note", document.getElementById("note").value || "");
  payload.set("vat_rate", document.getElementById("vat_rate").value || "0");

  const res = await fetch("/offer/meta", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: payload.toString()
  });

  if (!res.ok) {
    alert("Greška kod spremanja detalja.");
    return;
  }
  // refresh so totals reflect VAT change
  window.location.href = "/offer";
}
</script>
</body>
</html>
